version: '2'

services:

  start_dependencies:
    container_name: "wait-for-it"
    build: ./wait-for-it
    depends_on:
      - db
      - es
      - mongo
      - swift
    command: db:3306 es:9200 mongo:27017 swift:12345

  nginx:
    container_name: "ckweb"
    build: ./nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ~/Workspace/ck/platform/knowledgecenter/kc-web/src/main/webapp:/www/knowledgecenter

  es:
    container_name: "ckes"
    build: ./elasticsearch
    ports:
      - "9200:9200"
      - "9300:9300"

  db:
    container_name: "ckdb"
    build: ./mariadb
    ports:
      - "3306:3306"
    environment:
      - MASTER_PASSWORD=password@1234
      - MARIADB_DATABASE=b2b
      - MARIADB_USER=ckuser
      - MARIADB_PASSWORD=Cisco@1234

  mongo:
    container_name: "ckmongo"
    build: ./mongodb
    ports:
      - "27017:27017"

  genghis:
    container_name: "devtools"
    build: ./devtools
    ports:
      - "5678:5678"
    links:
      - mongo

  phpmyadmin:
    container_name: "phpmyadmin"
    image: phpmyadmin/phpmyadmin
    ports:
      - "8080:80"
    environment:
      PMA_HOST: db
      PMA_PORT: 3306
    links:
      - db


  authservice:
    image: rajasoun/java:0.1
    container_name: "authservice"
    ports:
       - "8006:8006"
    volumes:
       - ~/Workspace/ck/platform/authorization:/app
       - ~/Workspace/ck/devbox-docker/backbone/workers/scripts:/etc/b2b/scripts
    working_dir: /app
    command: "/etc/b2b/scripts/start.sh authorization 8006 authorization"
    environment:
        - jdbc.url=jdbc:mysql://ckdb:3306/b2b
    links:
      - db
    depends_on:
      - db

  knowledgecenter:
    container_name: "knowledgecenter"
    #image: openjdk:8
    image: anapsix/alpine-java:latest
    ports:
       - "8002:8002"
    volumes:
       - ~/Workspace/ck/platform/knowledgecenter:/app
       - ~/Workspace/ck/devbox-docker/backbone/workers/override-properties/kc:/etc/b2b/properties
       - ~/Workspace/ck/devbox-docker/backbone/workers/scripts:/etc/b2b/scripts
    working_dir: /app
    environment:
        CLASSPATH: /etc/b2b/properties
    command: "/etc/b2b/scripts/start.sh kc 8002 knowledgecenter"
    links:
      - mongo
    depends_on:
      - mongo

  userpi:
    container_name: "userpi"
    #image: openjdk:8
    image: anapsix/alpine-java:latest
    ports:
       - "8005:8005"
    volumes:
       - ~/Workspace/ck/platform/userpi:/app
       - ~/Workspace/ck/devbox-docker/backbone/workers/override-properties/userpi:/etc/b2b/properties
       - ~/Workspace/ck/devbox-docker/backbone/workers/scripts:/etc/b2b/scripts
    working_dir: /app
    environment:
        CLASSPATH: /etc/b2b/properties
    command: "/etc/b2b/scripts/start.sh userpi 8002 userpi"
    links:
      - mongo
      - swift
    depends_on:
      - mongo
      - swift

  kafka:
    container_name: "kafka"
    image: spotify/kafka
    ports:
      - "2181:2181"
      - "9092:9092"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      KAFKA_ADVERTISED_HOST_NAME: 10.10.10.1
      KAFKA_ADVERTISED_PORT: 9092

  swift:
     container_name: "swift"
     image: "morrisjobke/docker-swift-onlyone"
     ports:
        - "12345:8080"

#  portainer:
#     container_name: "portainer"
#     image: portainer/portainer
#     ports:
#       - "9001:9001"
#     volumes:
#       - /var/run/docker.sock:/var/run/docker.sock

